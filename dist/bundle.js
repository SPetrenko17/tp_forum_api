!function(e){var s={};function t(a){if(s[a])return s[a].exports;var n=s[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,t),n.l=!0,n.exports}t.m=e,t.c=s,t.d=function(e,s,a){t.o(e,s)||Object.defineProperty(e,s,{enumerable:!0,get:a})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,s){if(1&s&&(e=t(e)),8&s)return e;if(4&s&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(t.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&s&&"string"!=typeof e)for(var n in e)t.d(a,n,function(s){return e[s]}.bind(null,n));return a},t.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(s,"a",s),s},t.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},t.p="",t(t.s=2)}([function(e,s,t){"use strict";t.r(s),t.d(s,"db",(function(){return n})),t.d(s,"notNullError",(function(){return d})),t.d(s,"dataConflict",(function(){return o})),t.d(s,"dataDoesNotExist",(function(){return r})),t.d(s,"notFound",(function(){return u}));const a=t(3),n=t(4)({promiseLib:a})("postgres://docker:docker@localhost:5432/docker"),d="23502",o="23505",r="23503",u="42601"},function(e,s,t){const a=t(0),{db:n}=a;async function d(e,s,t){const a=t,{limit:d}=e.query,{since:o}=e.query;let{sort:r}=e.query;const{desc:u}=e.query;let i;void 0===r&&(r="flat");let c=[];if("flat"===r){i="SELECT id, thread_id AS thread, created,\n    message, parent_id AS parent, author, forum_slug AS forum FROM\n    (SELECT * FROM posts WHERE thread_id = $1 ",c=[a];let e=2;void 0!==o&&(i+="true"===u?" AND id < $"+e++:" AND id > $"+e++,c.push(o)),i+=" ) p ",i+="true"===u?" ORDER BY created DESC, id DESC ":" ORDER BY created, id  ",void 0!==d&&(i+=" LIMIT $"+e++,c.push(d))}else if("tree"===r){let e,s,t,n=2;c=[],c.push(a),void 0!==o?(e=` AND (path ${"true"===u?"<":">"}\n        (SELECT path FROM posts WHERE id = $${n++})) `,c.push(o)):e="",s="true"===u?" DESC ":"",void 0!==d?(t=" LIMIT $"+n++,c.push(d)):t="",i=`\n      SELECT id, author, created, message, parent_id AS parent,\n        forum_slug AS forum, thread_id AS thread\n        FROM posts\n        WHERE thread_id = $1 ${e}\n        ORDER BY path ${s}\n        ${t}\n    `}else{c=[a];const e="true"===u?"DESC":"";let s,t,n=2;void 0!==o?(s=`\n        AND id ${"true"===u?"<":">"} (SELECT path[1] FROM posts WHERE id = $${n++})`,c.push(o)):s="",void 0!==d?(t="LIMIT $"+n++,c.push(d)):t="LIMIT 100000",i=`\n    SELECT author, created, forum_slug AS forum, id, edited,\n      message, parent_id AS parent, thread_id AS thread\n      FROM posts\n      WHERE path[1] IN (\n        SELECT id FROM posts\n        WHERE thread_id=$1 AND parent_id IS NULL\n        ${s}\n        ORDER BY id ${e}\n        ${t}\n      ) AND thread_id=$1\n      ORDER BY path[1] ${e}, path;\n    `}n.any({text:i,values:c}).then(async e=>{if(0===e.length){let e="SELECT threads.id FROM threads WHERE ";isNaN(a),e+="threads.id = $1",await n.one({text:e,values:a}).then(e=>{0===e.length?s.code(404).send({message:"Can't find thread with id #42"}):s.code(200).send([])}).catch(e=>{0===e.code?s.code(404).send({message:"Can't find thread with id #42"}):s.code(500).send(e)})}s.code(200).send(e)}).catch(e=>{0===e.code?s.code(404).send({message:"Can't find thread with id #42"}):s.code(500).send(e)})}e.exports={createThread:async function(e,s){const t=e.body.slug?e.body.slug:null,d=e.body.forum?e.body.forum:e.params.slug;let o="";e.body.slug&&(o=", slug");const r={text:"INSERT INTO threads (author, created, forum, message, title, slug) VALUES\n    ((SELECT nickname FROM users WHERE nickname=$1),\n    $2, (SELECT slug FROM forums WHERE slug=$3),$4, $5, $6)\n    RETURNING author, created, forum, message, title, votes, id "+o,values:[e.body.author,e.body.created,d,e.body.message,e.body.title,t]};n.one(r).then(async t=>{await n.none({text:"\n        INSERT INTO forum_users(user_id,forum_slug, username) VALUES\n          ((SELECT id FROM users WHERE users.nickname = $2), $1, $2) ON CONFLICT DO NOTHING\n      ",values:[d,e.body.author]}),s.code(201).send(t)}).catch(e=>{e.code===a.dataConflict?n.one({text:"SELECT * FROM threads WHERE slug=$1",values:[t]}).then(e=>{s.code(409).send(e)}).catch(e=>{s.code(500).send(e)}):e.code===a.notNullError?s.code(404).send(e):s.code(500).send(e)})},getThreads:async function(e,s){const t=e.query.desc;let d,o,r;d="true"===t?"DESC":"ASC",o=e.query.limit?"LIMIT "+e.query.limit:"",r=e.query.since?"true"===t?`AND created <= '${e.query.since}'`:`AND created >= '${e.query.since}'`:"",n.any({text:`SELECT * FROM threads WHERE forum=$1 ${r} ORDER BY created ${d} ${o};`,values:[e.params.slug]}).then(t=>{0===t.length?n.one({text:"SELECT * FROM forums WHERE slug=$1",values:[e.params.slug]}).then(()=>{s.code(200).send(t)}).catch(t=>{0===t.code?s.code(404).send({message:"Can't find threads by forum "+e.params.slug}):s.code(500).send(t)}):s.code(200).send(t)}).catch(t=>{t.code===a.notFound?s.code(404).send({message:"Can't find threads by forum "+e.params.slug}):s.code(500).send(t)})},getThreadInfo:async function(e,s){let t="\n    SELECT author, created, forum, id, message, votes, slug, title FROM threads\n      WHERE\n  ";isNaN(e.params.slug)?t+=" slug = $1":t+=" id = $1",n.one({text:t,values:[e.params.slug]}).then(t=>{0===t.length&&s.code(404).send({message:"Can't find forum by slug "+e.params.slug}),s.code(200).send(t)}).catch(t=>{0===t.code&&s.code(404).send({message:"Can't find forum by slug "+e.params.slug})})},getPosts:async function(e,s){isNaN(e.params.slug)?n.one({text:"SELECT id FROM threads WHERE slug=$1",values:[e.params.slug]}).then(t=>{d(e,s,t.id)}).catch(()=>{s.code(404).send({message:"Can't find thread with id #42"})}):d(e,s,e.params.slug)},updateThread:async function(e,s){let t,a=[],d=1;const o=e.body.title,r=e.body.message;void 0===o&&void 0===r?(t="\n      SELECT created, id, title,\n        slug, message, author, forum\n        FROM threads WHERE\n    ",isNaN(e.params.slug)?t+="slug = $1 LIMIT 1":t+="id = $1 LIMIT 1",a=[e.params.slug]):(t="UPDATE threads SET ",void 0!==o&&(t+=`title = $${d++},`,a.push(o)),void 0!==r&&(t+=`message = $${d++},`,a.push(r)),t=t.slice(0,-1),t+=" WHERE ",isNaN(e.params.slug)?t+=`\n        slug = $${d++}\n        RETURNING created, id, title,\n          slug, message,\n          author, forum\n      `:t+=`\n        id = $${d++}\n        RETURNING created, id, title,\n          slug, message,\n          author, forum\n      `,a.push(e.params.slug)),n.one({text:t,values:a}).then(t=>{0===t.length?s.code(404).send({message:"Can't find thread by slug: "+e.params.slug}):s.code(200).send(t)}).catch(t=>{0===t.code?s.code(404).send({message:"Can't find thread by slug: "+e.params.slug}):s.code(500).send(t)})}}},function(e,s,t){e.exports=t(6)},function(e,s){e.exports=require("bluebird")},function(e,s){e.exports=require("pg-promise")},function(e,s){e.exports=require("fastify")},function(e,s,t){"use strict";t.r(s);const a=t(0),{db:n}=a;var d=new class{async createUser(e,s){const t={nickname:e.params.nickname,fullname:e.body.fullname,email:e.body.email,about:e.body.about};n.one({text:"INSERT INTO users (nickname, fullname, email, about) VALUES ($1, $2, $3, $4) RETURNING *",values:[t.nickname,t.fullname,t.email,t.about]}).then(e=>{s.code(201).send(e)}).catch(e=>{e.code===a.dataConflict&&n.any({text:"SELECT * FROM users WHERE nickname=$1 OR email=$2",values:[t.nickname,t.email]}).then(e=>{s.code(409).send(e)}).catch(e=>{s.code(500).send(e)})})}async getUserInfo(e,s){n.one({text:"SELECT about, email, nickname, fullname FROM users WHERE nickname=$1;",values:[e.params.nickname]}).then(t=>{0===t.length&&s.code(404).send({message:"Can't find user by nickname "+e.params.nickname}),s.code(200).send(t)}).catch(e=>{0===e.code&&s.code(404).send({message:"Can't find user with id #42"})})}async updateUserInfo(e,s){let t="UPDATE users SET ";e.body.fullname?t+=`fullname = '${e.body.fullname}', `:t+="fullname = fullname, ",e.body.email?t+=`email = '${e.body.email}', `:t+="email = email, ",e.body.about?t+=`about = '${e.body.about}' `:t+="about = about ",t+=`\n    WHERE nickname = '${e.params.nickname}'\n    RETURNING *`,n.one(t).then(t=>{0===t.length&&s.code(404).send({message:"Can't find user by nickname "+e.params.nickname}),s.code(200).send(t)}).catch(e=>{0===e.code?s.code(404).send({message:"Can't find user with id #42"}):e.code===a.dataConflict&&s.code(409).send({message:"Can't find user with id #42"})})}};const o=t(0),{db:r}=o;var u=new class{async createForum(e,s){r.one({text:'INSERT INTO forums (slug, title, "user") VALUES\n    ($1, $2, (SELECT nickname FROM users WHERE nickname=$3)) RETURNING *',values:[e.body.slug,e.body.title,e.body.user]}).then(e=>{s.code(201).send(e)}).catch(t=>{t.code===o.dataConflict?r.one({text:'SELECT slug, title, "user" FROM forums WHERE slug=$1',values:[e.body.slug]}).then(e=>{s.code(409).send(e)}):t.code===o.notNullError&&s.code(404).send(t)})}async getForumInfo(e,s){r.one({text:"SELECT * FROM forums WHERE slug=$1;",values:[e.params.slug]}).then(t=>{0===t.length&&s.code(404).send({message:"Can't find forum by slug "+e.params.slug}),s.code(200).send(t)}).catch(t=>{0===t.code&&s.code(404).send({message:"Can't find forum by slug "+e.params.slug})})}async getForumUsers(e,s){const{desc:t}=e.query,{limit:a}=e.query,{since:n}=e.query,{slug:d}=e.params;let o='\n    SELECT u.* FROM "users" u\n    JOIN forum_users f ON u.id = f.user_id\n    WHERE\n      f.forum_slug = $1\n    ';const u=[d];let i=2;void 0!==n&&(o+="true"===t?` AND f.username < $${i++} COLLATE "C" `:` AND f.username > $${i++} COLLATE "C" `,u.push(n)),o+="true"===t?' ORDER BY f.username COLLATE "C" DESC ':' ORDER BY f.username COLLATE "C" ASC ',void 0!==a&&(o+=" LIMIT $"+i++,u.push(a)),r.any({text:o,values:u}).then(e=>{0===e.length?r.one({text:"SELECT id FROM forums WHERE slug = $1 LIMIT 1",values:[d]}).then(e=>{0!==e.length?s.code(200).send([]):s.code(500).send({message:"Everything is empty",forumInfo:e})}).catch(e=>{0===e.code?s.code(404).send({message:"Can't find forum by slug "+d}):s.code(500).send(e)}):s.header("Content-Type","application/json").type("application/json").code(200).send(e)}).catch(e=>{0===e.code?s.code(404).send({message:"Can't find forum by slug "+d}):s.code(500).send(e)})}},i=t(1),c=t.n(i);const l=t(0),{db:m}=l;var E=new class{async createPost(e,s){let t="SELECT id AS thread_id, forum FROM threads WHERE ";isNaN(e.params.slug)?t+=" slug = $1":t+=" id = $1";const a=e.body;l.postsCount+=a.length,m.one({text:t,values:e.params.slug}).then(n=>{0===a.length&&s.code(201).send([]),0===n.length&&s.code(404).send({message:"Can't find thread by slug "+e.params.slug}),t="INSERT INTO posts (id, edited, author, message,thread_id, parent_id, path, forum_slug) VALUES ";const d=[];let o=1;const r=[];for(let e=0;e<a.length;e++)r.push(a[e].author),void 0!==a[e].parent?(t+=`((SELECT nextval('posts_id_seq')::integer),\n            FALSE, $${o}, $${o+1}, (\n              SELECT (\n                CASE WHEN\n                EXISTS (\n                  SELECT 1 FROM posts p\n                  WHERE p.id=$${o+3}\n                  AND p.thread_id=$${o+2}\n                )\n                THEN $${o+2} ELSE NULL END)\n            ), $${o+3},  array_append(\n              (SELECT path FROM posts WHERE id=$${o+3}),\n                (SELECT currval('posts_id_seq')::integer)),\n                $${o+4}),`,o+=5,d.push(a[e].author,a[e].message,n.thread_id,a[e].parent,n.forum)):(t+=`((SELECT nextval('posts_id_seq')::integer),\n            FALSE, $${o}, $${o+1}, $${o+2}, NULL,\n              array_append('{}', (SELECT currval('posts_id_seq')::integer)), $${o+3}),`,o+=4,d.push(a[e].author,a[e].message,n.thread_id,n.forum));t=t.slice(0,-1),t+=" RETURNING author, id, created,\n        thread_id AS thread, parent_id AS parent, forum_slug AS forum, message",m.any(t,d).then(async e=>{await m.none("UPDATE forums SET posts=forums.posts+$1 WHERE slug=$2",[a.length,n.forum]);let t="INSERT INTO forum_users(user_id, forum_slug, username) VALUES",d=1;const o=[];for(let e=0;e<r.length;e++)t+=`((SELECT id FROM users WHERE users.nickname = $${d+1}),\n              $${d}, $${d+1}),`,d+=2,o.push(n.forum,r[e]);t=t.slice(0,-1),t+=" ON CONFLICT DO NOTHING",await m.none(t,o).catch(e=>console.log(e)),s.code(201).send(e)}).catch(e=>{console.log(e),e.code===l.notNullError?s.code(409).send({message:"Parent post was created in another thread"}):e.code===l.dataDoesNotExist?s.code(404).send({message:"User not found"}):e.code===l.notNullError?s.code(404).send({message:"Can't find user with id #"}):s.code(500).send(e)})}).catch(e=>{0===e.code?s.code(404).send({message:"Can't find user with id #"}):s.code(500).send(e)})}async getPostInfo(e,s){const t=e.params.slug,a=e.query.related;let n,d,o,r;if(void 0!==a&&(n=a.includes("user"),d=a.includes("thread"),o=a.includes("forum")),void 0===a)r='SELECT id, parent_id AS parent, thread_id AS thread, message, edited AS "isEdited", created, forum_slug AS forum, author FROM posts WHERE id = $1 LIMIT 1',m.one('SELECT id, parent_id AS parent, thread_id AS thread, message, edited AS "isEdited", created, forum_slug AS forum, author FROM posts WHERE id = $1 LIMIT 1',[t]).then(e=>{s.code(200).send({post:e})}).catch(e=>{0===e.code?s.code(404).send({message:"Can't find post with id "+t}):s.code(500).send(e)});else{let e="\n      SELECT posts.id AS pid, posts.parent_id AS pparent,\n        posts.thread_id AS pthread, posts.message AS pmessage,\n        posts.edited AS pisedited, posts.created AS pcreated,\n        posts.forum_slug AS pforumslug, posts.author AS pauthor,",a=" FROM posts ";n&&(e+="\n        U.nickname AS unickname, U.about AS uabout,\n        U.fullname AS ufullname, U.email AS uemail,",a+="LEFT JOIN users U ON U.nickname = posts.author "),d&&(e+="\n        threads.author AS tauthor, threads.created AS tcreated,\n        threads.votes AS tvotes, threads.id AS tid,\n        threads.title AS ttitle, threads.message AS tmessage,\n        threads.slug AS tslug, threads.forum AS tforumslug,",a+="LEFT JOIN threads ON threads.id = posts.thread_id "),o&&(e+='\n        F.slug AS fslug, F.threads AS fthreads, F.title as ftitle,\n        F.posts AS fposts, F."user" AS fuser_nickname,',a+="LEFT JOIN forums F ON F.slug = posts.forum_slug "),a+=" WHERE posts.id = $1 LIMIT 1";const r=e.slice(0,-1)+a;m.one(r,t).then(e=>{const t={};t.post={author:e.pauthor,id:e.pid,thread:e.pthread,parent:e.pparent,forum:e.pforumslug,message:e.pmessage,isEdited:e.pisEdited,created:e.pcreated},o&&(t.forum={threads:e.fthreads,posts:e.fposts,title:e.ftitle,user:e.fuser_nickname,slug:e.fslug}),n&&(t.author={nickname:e.unickname,about:e.uabout,fullname:e.ufullname,email:e.uemail}),d&&(t.thread={forum:e.tforumslug,author:e.tauthor,created:e.tcreated,votes:e.tvotes,id:e.tid,title:e.ttitle,message:e.tmessage,slug:e.tslug}),s.code(200).send(t)}).catch(e=>{0===e.code?s.code(404).send({message:"Can't find thread with id "+t}):s.code(500).send(e)})}}async updatePost(e,s){let t;const a=[];void 0===e.body.message?(t="\n      SELECT id, author, message, created,\n      forum_slug AS forum,\n      thread_id AS thread\n      FROM posts WHERE id=$1\n      ",a.push(e.params.id)):(t='\n    UPDATE posts SET edited = message <> $1, message = $1\n      WHERE id = $2\n      RETURNING id, message, author, created, forum_slug AS forum,\n        parent_id AS parent, thread_id AS thread, edited AS "isEdited"\n\n    ',a.push(e.body.message,e.params.id)),m.one(t,a).then(t=>{0===t.length&&s.code(404).send({message:"Can't find post by id "+e.params.id}),s.code(200).send(t)}).catch(t=>{0===t.code?s.code(404).send({message:"Can't find post by id "+e.params.id}):t.code===l.dataConflict&&s.code(409).send({message:"Can't find user with id #"})})}};const h=t(0).db;var p=new class{async createVote(e,s){let t,a=" SELECT id, created, slug, title, forum,\n    author, message, votes FROM threads WHERE ";isNaN(e.params.slug)?a+=`slug = '${e.params.slug}' LIMIT 1`:a+=`id = '${e.params.slug}' LIMIT 1`,t=isNaN(e.params.slug)?{text:"INSERT INTO votes (thread_id, user_id, voice)\n      VALUES (\n        (SELECT id FROM threads WHERE slug=$1), $2, $3\n      )\n      ON CONFLICT ON CONSTRAINT votes_user_thread_unique\n        DO UPDATE SET voice = $3\n        WHERE votes.thread_id = (SELECT id FROM threads WHERE slug = $1)\n          AND votes.user_id = $2\n      ",values:[e.params.slug,e.body.nickname,e.body.voice]}:{text:"INSERT INTO votes (thread_id, user_id, voice)\n              VALUES ($1, $2, $3)\n              ON CONFLICT ON CONSTRAINT votes_user_thread_unique\n              DO UPDATE SET voice = $3\n              WHERE votes.thread_id = $1 AND votes.user_id = $2\n      ",values:[+e.params.slug,e.body.nickname,e.body.voice]},h.none(t).then(()=>{h.one(a).then(e=>{s.code(200).send(e)}).catch(e=>{s.code(500).send(e)})}).catch(e=>{s.code(404).send({message:"Can't find user with id #42\n"})})}};const g=t(0),{db:f}=g;var S=new class{async ping(e,s){f.none({text:"ANALYZE"}),s.code(200).send({})}async status(e,s){f.one('\n    SELECT (\n      SELECT COUNT(*) FROM forums) AS forum,\n      (SELECT COUNT(*) FROM   users) AS "user",\n      (SELECT COUNT(*) FROM threads) AS thread,\n      (SELECT COUNT(*) FROM posts) AS post\n    ').then(e=>{e.forum=parseInt(e.forum,10),e.user=parseInt(e.user,10),e.thread=parseInt(e.thread,10),e.post=parseInt(e.post,10),s.code(200).send(e)}).catch(e=>{s.code(500).send(e)})}async clear(e,s){g.counter={forum:0,thread:0,user:0,post:0},f.none("\n    TRUNCATE TABLE forum_users, votes, posts, threads, forums, users;\n  ").then(()=>{s.code(200).send(null)}).catch(e=>{s.code(500).send(e)})}};const T=t(5)({logger:{level:"error"}});T.addContentTypeParser("application/json",{parseAs:"buffer"},(e,s,t)=>{s.length>0?t(null,JSON.parse(s)):t(null,{})}),T.listen(5e3,"0.0.0.0",()=>{console.log("Started on 5000")}),T.get("/api",S.ping),T.post("/api/user/:nickname/create",d.createUser),T.get("/api/user/:nickname/profile",d.getUserInfo),T.post("/api/user/:nickname/profile",d.updateUserInfo),T.post("/api/forum/create",u.createForum),T.get("/api/forum/:slug/details",u.getForumInfo),T.post("/api/forum/:slug/create",c.a.createThread),T.get("/api/forum/:slug/threads",c.a.getThreads),T.post("/api/thread/:slug/create",E.createPost),T.post("/api/thread/:slug/vote",p.createVote),T.get("/api/thread/:slug/details",c.a.getThreadInfo),T.get("/api/thread/:slug/posts",c.a.getPosts),T.post("/api/thread/:slug/details",c.a.updateThread),T.get("/api/forum/:slug/users",u.getForumUsers),T.get("/api/post/:slug/details",E.getPostInfo),T.get("/api/service/status",S.status),T.post("/api/service/clear",S.clear),T.post("/api/post/:id/details",E.updatePost)}]);